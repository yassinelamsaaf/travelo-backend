name: Backend CI Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # Phase 1: Static Analysis (run in parallel)
  sast:
    name: SAST - Semgrep
    uses: Alae-J/travelo-ci-templates/.github/workflows/sast-semgrep.yml@main
    permissions:
      contents: read
      security-events: write
    with:
      config: 'p/java,p/security-audit,p/owasp-top-ten'
      fail-on-findings: true

  sca:
    name: SCA - Maven Dependencies
    uses: Alae-J/travelo-ci-templates/.github/workflows/sca-maven.yml@main
    permissions:
      contents: read
      security-events: write
    with:
      cvss-threshold: 6
      java-version: '23'
      fail-on-findings: true
    secrets:
      snyk-token: ${{ secrets.SNYK_TOKEN }}

  # Phase 2: Build (only after security passes)
  build:
    name: Build Docker Image
    needs: [sast, sca]
    uses: Alae-J/travelo-ci-templates/.github/workflows/docker-build.yml@main
    with:
      image-name: lamsaafyassine/travelo-backend
      artifact-name: backend-image
      enable-cache: false

  # Phase 3: Container Security
  container-security:
    name: Container Security - Trivy
    needs: build
    if: github.ref == 'refs/heads/main' || github.base_ref == 'refs/heads/main'
    uses: Alae-J/travelo-ci-templates/.github/workflows/container-security.yml@main
    permissions:
      contents: read
      security-events: write
    with:
      scan-type: image
      image-name: lamsaafyassine/travelo-backend
      artifact-name: backend-image
      severity: 'MEDIUM,HIGH,CRITICAL'
      fail-on-findings: true
      scan-dockerfile: true

  # Phase 4: Push (only if security passes)
  push:
    name: Push to Docker Hub
    needs: container-security
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: Alae-J/travelo-ci-templates/.github/workflows/docker-push.yml@main
    with:
      image-name: lamsaafyassine/travelo-backend
      artifact-name: backend-image
      support-version-tags: false
    secrets:
      dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}

  # Phase 5: GitOps Deploy
  deploy:
    name: GitOps Deploy to K8s
    needs: push
    if: github.ref == 'refs/heads/main'
    uses: Alae-J/travelo-ci-templates/.github/workflows/gitops-deploy.yml@main
    with:
      image-name: lamsaafyassine/travelo-backend
      yaml-file: backend.yaml
      infra-repo: yassinelamsaaf/travelo-infra
      support-version-tags: false
    secrets:
      infra-token: ${{ secrets.INFRA_REPO_TOKEN }}

  # Security Failure Notifications
  notify-security-failure:
    name: Notify Security Failures
    needs: [sast, sca, container-security]
    if: always() && (needs.sast.result == 'failure' || needs.sca.result == 'failure' || needs.container-security.result == 'failure')
    uses: Alae-J/travelo-ci-templates/.github/workflows/notify-slack.yml@main
    with:
      app-name: 'Backend'
      failed-scans: ${{ (needs.sast.result == 'failure' && 'SAST (Semgrep)' || '') }}${{ (needs.sast.result == 'failure' && needs.sca.result == 'failure' && ',' || '') }}${{ (needs.sca.result == 'failure' && 'SCA (OWASP Dependency-Check)' || '') }}${{ ((needs.sast.result == 'failure' || needs.sca.result == 'failure') && needs.container-security.result == 'failure' && ',' || '') }}${{ (needs.container-security.result == 'failure' && 'Container Security (Trivy)' || '') }}
      workflow-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      branch: ${{ github.ref_name }}
    secrets:
      slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
